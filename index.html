<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Проверка подписки @SimpleDLC</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h2>Проверка подписки на канал @SimpleDLC</h2>
    
    <div>
        <p><strong>Ваш ID:</strong></p>
        <p id="userId">Загрузка...</p>
        
        <p><strong>Статус подписки:</strong></p>
        <p id="subscriptionStatus">Проверка...</p>
        
        <p><strong>Подписчиков в канале:</strong></p>
        <p id="subscriberCount">-</p>
    </div>
    
    <div>
        <button onclick="checkSubscription()">Проверить подписку</button>
        <button onclick="openChannel()">Перейти в канал</button>
        <button onclick="getChannelStats()">Обновить статистику</button>
    </div>
    
    <p id="lastUpdate"></p>
    
    <div id="loader" style="display:none;">
        <p>Загрузка...</p>
    </div>

    <script>
        // ВАЖНО: Замените на свой токен бота
        const BOT_TOKEN = '5718405917:AAEtLH8r_FEh98utTX7-1iSRBBifbMJ0REY';
        const CHANNEL_USERNAME = '@SimpleDLC';
        
        let telegramUser = null;
        
        // Функция для показа/скрытия лоадера
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
        
        // Инициализация Telegram Web App
        function initTelegram() {
            const tg = window.Telegram.WebApp;
            
            // Получаем данные пользователя
            telegramUser = tg.initDataUnsafe?.user;
            
            if (telegramUser) {
                document.getElementById('userId').textContent = telegramUser.id;
            } else {
                document.getElementById('userId').textContent = 'Не удалось получить ID';
                document.getElementById('subscriptionStatus').textContent = 
                    'Откройте через Telegram бота';
            }
            
            tg.expand();
        }
        
        // Проверка подписки пользователя
        async function checkSubscription() {
            if (!telegramUser) {
                document.getElementById('subscriptionStatus').textContent = 
                    'Сначала авторизуйтесь в Telegram';
                return;
            }
            
            showLoader(true);
            
            try {
                // Проверяем, является ли пользователь участником канала
                const response = await fetch(
                    `https://api.telegram.org/bot${BOT_TOKEN}/getChatMember`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: CHANNEL_USERNAME,
                            user_id: telegramUser.id
                        })
                    }
                );
                
                const data = await response.json();
                
                if (data.ok) {
                    const status = data.result.status;
                    
                    // Статусы участника канала
                    const statusMap = {
                        'creator': 'Создатель канала',
                        'administrator': 'Администратор',
                        'member': 'Подписан',
                        'restricted': 'Ограниченный доступ',
                        'left': 'Не подписан',
                        'kicked': 'Заблокирован'
                    };
                    
                    const statusText = statusMap[status] || status;
                    document.getElementById('subscriptionStatus').textContent = statusText;
                    
                    // Подсветка статуса
                    if (status === 'left' || status === 'kicked') {
                        document.getElementById('subscriptionStatus').style.color = 'red';
                    } else {
                        document.getElementById('subscriptionStatus').style.color = 'green';
                    }
                    
                } else {
                    document.getElementById('subscriptionStatus').textContent = 
                        'Ошибка: ' + (data.description || 'Неизвестная ошибка');
                }
            } catch (error) {
                document.getElementById('subscriptionStatus').textContent = 
                    'Ошибка соединения';
                console.error('Error:', error);
            }
            
            updateTime();
            showLoader(false);
        }
        
        // Получение статистики канала
        async function getChannelStats() {
            showLoader(true);
            
            try {
                const response = await fetch(
                    `https://api.telegram.org/bot${BOT_TOKEN}/getChatMembersCount?chat_id=${CHANNEL_USERNAME}`
                );
                const data = await response.json();
                
                if (data.ok) {
                    document.getElementById('subscriberCount').textContent = data.result;
                } else {
                    document.getElementById('subscriberCount').textContent = 'Ошибка';
                }
            } catch (error) {
                document.getElementById('subscriberCount').textContent = 'Ошибка сети';
            }
            
            updateTime();
            showLoader(false);
        }
        
        // Функция открытия канала
        function openChannel() {
            const tg = window.Telegram.WebApp;
            if (tg.openTelegramLink) {
                tg.openTelegramLink(`https://t.me/${CHANNEL_USERNAME.substring(1)}`);
            } else {
                window.open(`https://t.me/${CHANNEL_USERNAME.substring(1)}`, '_blank');
            }
        }
        
        // Обновление времени
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                'Обновлено: ' + now.toLocaleTimeString();
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            getChannelStats();
            
            // Автоматически проверяем подписку через 1 секунду
            setTimeout(() => {
                if (telegramUser) {
                    checkSubscription();
                }
            }, 1000);
        });
    </script>
</body>
</html>
